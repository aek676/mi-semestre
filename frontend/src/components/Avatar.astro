---
import { api } from '@/lib/apiClient';

const {
  avatarUrl,
  sessionToken,
  size = 100,
  alt = 'Avatar',
  className = '',
} = Astro.props as {
  avatarUrl: string;
  sessionToken?: string;
  size?: number;
  alt?: string;
  className?: string;
};

let imageSrc: string | null = null;

if (avatarUrl && sessionToken) {
  try {
    const response = await api.api.imageProxyList(
      { imageUrl: avatarUrl },
      {
        headers: {
          'X-Session-Cookie': sessionToken,
        },
      },
    );

    if (response.data) {
      const blob = response.data as unknown as Blob;
      const buffer = await blob.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
      const contentType = blob.type || 'image/jpeg';
      imageSrc = `data:${contentType};base64,${base64}`;
    }
  } catch (err) {
    console.error('Failed to fetch avatar image:', err);
    imageSrc = null;
  }
}

const getInitials = (name: string): string => {
  const words = name.trim().split(/\s+/);
  if (words.length >= 2) {
    return (words[0][0] + words[words.length - 1][0]).toUpperCase();
  }
  return name.substring(0, 2).toUpperCase();
};
---

{
  imageSrc ? (
    <img
      src={imageSrc}
      alt={alt}
      loading="lazy"
      decoding="async"
      class={`rounded-full object-cover ${className}`}
      style={`width: ${size}px; height: ${size}px;`}
    />
  ) : (
    <div
      class={`bg-linear-to-br from-gray-400 to-gray-600 text-white rounded-full flex items-center justify-center font-semibold ${className}`}
      style={`width: ${size}px; height: ${size}px; font-size: ${size / 2.5}px;`}
    >
      {getInitials(alt)}
    </div>
  )
}
